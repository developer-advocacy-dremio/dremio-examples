/*
 * Dremio "Messy Data" Challenge: Smart Grid Voltage
 * 
 * Scenario: 
 * AMI Meter data recording Voltage and KW.
 * 3 Tables: METERS (Meta), READINGS (TimeSeries), EVENT_LOGS (Outages).
 * 
 * Objective for AI Agent:
 * 1. Join Tables: Link READINGS to METERS to get 'Grid_Zone'.
 * 2. Correlate Events: Match READINGS.TS with EVENT_LOGS.OUTAGE_TS.
 * 3. Clean Voltage: Filter spikes > 250V.
 */

-------------------------------------------------------------------------------
-- 1. SETUP: Create Raw Folder
-------------------------------------------------------------------------------

CREATE FOLDER IF NOT EXISTS Power_Grid;
CREATE FOLDER IF NOT EXISTS Power_Grid.AMI_Data;

-------------------------------------------------------------------------------
-- 2. DDL: Create Raw Tables (3 Tables)
-------------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS Power_Grid.AMI_Data.METERS (
    METER_ID VARCHAR,
    GRID_ZONE VARCHAR,
    FIRMWARE_VER VARCHAR,
    INSTALL_DATE DATE
);

CREATE TABLE IF NOT EXISTS Power_Grid.AMI_Data.READINGS (
    READING_ID VARCHAR,
    METER_ID VARCHAR,
    TS TIMESTAMP,
    VOLTAGE DOUBLE,
    KW_LOAD DOUBLE
);

CREATE TABLE IF NOT EXISTS Power_Grid.AMI_Data.EVENT_LOGS (
    EVENT_ID VARCHAR,
    METER_ID VARCHAR,
    EVENT_TYPE VARCHAR, -- 'PowerOut', 'Tamper', 'Sag'
    EVENT_TS TIMESTAMP
);

-------------------------------------------------------------------------------
-- 3. SEED DATA (50+ Records)
-------------------------------------------------------------------------------

-- METERS (10 Row)
INSERT INTO Power_Grid.AMI_Data.METERS VALUES
('M-100', 'Zone-A', 'v1.0', '2020-01-01'), ('M-101', 'Zone-A', 'v1.1', '2020-06-01'),
('M-102', 'Zone-B', 'v1.0', '2021-01-01'), ('M-103', 'Zone-B', 'v2.0', '2022-01-01'),
('M-104', 'Zone-C', 'v0.9', '2019-01-01'), ('M-105', 'Zone-C', 'v1.0', '2020-01-01'),
('M-106', 'Zone-A', 'v1.0', '2020-01-01'), ('M-107', 'Zone-B', 'v1.2', '2021-01-01'),
('M-108', 'Zone-C', 'v2.0', '2022-06-01'), ('M-109', 'Zone-A', 'v1.0', '2020-01-01');

-- READINGS (40+ Rows)
INSERT INTO Power_Grid.AMI_Data.READINGS VALUES
('R-1', 'M-100', '2023-01-01 12:00:00', 120.1, 1.5), ('R-2', 'M-100', '2023-01-01 12:15:00', 119.8, 1.6),
('R-3', 'M-100', '2023-01-01 12:30:00', 150.0, 1.5), ('R-4', 'M-100', '2023-01-01 12:45:00', 0.0, 0.0),
('R-5', 'M-101', '2023-01-01 12:00:00', 121.0, 2.0), ('R-6', 'M-101', '2023-01-01 12:15:00', 121.1, 2.0),
('R-7', 'M-101', '2023-01-01 12:30:00', 121.2, 2.1), ('R-8', 'M-101', '2023-01-01 12:45:00', 121.0, 2.0),
('R-9', 'M-102', '2023-01-01 12:00:00', 240.0, 5.0), ('R-10', 'M-102', '2023-01-01 12:15:00', 239.5, 5.0),
('R-11', 'M-102', '2023-01-01 12:30:00', 1000.0, 5.0), ('R-12', 'M-102', '2023-01-01 12:45:00', 240.0, 5.0),
('R-13', 'M-103', '2023-01-01 12:00:00', 120.0, 0.5), ('R-14', 'M-103', '2023-01-01 12:15:00', NULL, 0.5),
('R-15', 'M-103', '2023-01-01 12:30:00', 120.0, NULL), ('R-16', 'M-103', '2023-01-01 12:45:00', 120.0, 0.5),
('R-17', 'M-104', '2023-01-01 09:00:00', 115.0, 1.0), ('R-18', 'M-104', '2023-01-01 09:15:00', 110.0, 1.0),
('R-19', 'M-104', '2023-01-01 09:30:00', 105.0, 1.0), ('R-20', 'M-104', '2023-01-01 09:45:00', 100.0, 1.0),
('R-21', 'M-105', '2023-01-01 12:00:00', -120.0, 1.0), ('R-22', 'M-106', '2023-01-01 12:00:00', 120.0, -5.0),
('R-23', 'M-107', '2023-01-01 12:00:00', 120.0, 1.0), ('R-24', 'M-107', '2023-01-01 12:00:00', 120.0, 1.0),
('R-25', 'M-108', '2023-01-01 12:00:00', 120.0, 100.0), ('R-26', 'M-109', '2023-01-01 12:00:00', 120.0, 0.0001),
('R-27', 'M-100', '2023-01-01 13:00:00', 120.0, 1.0), ('R-28', 'M-100', '2023-01-01 13:15:00', 120.0, 1.0),
('R-29', 'M-100', '2023-01-01 13:30:00', 120.0, 1.0), ('R-30', 'M-100', '2023-01-01 13:45:00', 120.0, 1.0),
('R-31', 'M-100', '2023-01-01 14:00:00', 120.0, 1.0), ('R-32', 'M-100', '2023-01-01 14:15:00', 120.0, 1.0),
('R-33', 'M-100', '2023-01-01 14:30:00', 120.0, 1.0), ('R-34', 'M-100', '2023-01-01 14:45:00', 120.0, 1.0),
('R-35', 'M-100', '2023-01-01 15:00:00', 120.0, 1.0), ('R-36', 'M-100', '2023-01-01 15:15:00', 120.0, 1.0),
('R-37', 'M-101', '2023-01-01 15:00:00', 120.0, 1.0), ('R-38', 'M-101', '2023-01-01 15:15:00', 120.0, 1.0),
('R-39', 'M-101', '2023-01-01 15:30:00', 120.0, 1.0), ('R-40', 'M-101', '2023-01-01 15:45:00', 120.0, 1.0);

-- EVENT LOGS (10 Rows)
INSERT INTO Power_Grid.AMI_Data.EVENT_LOGS VALUES
('E-1', 'M-100', 'PowerOut', '2023-01-01 12:45:00'),
('E-2', 'M-102', 'Sag', '2023-01-01 12:15:00'),
('E-3', 'M-104', 'Sag', '2023-01-01 09:30:00'),
('E-4', 'M-100', 'Tamper', '2023-01-01 10:00:00'),
('E-5', 'M-105', 'PowerOut', '2023-01-01 12:00:00'),
('E-6', 'M-106', 'Unknown', '2023-01-01 12:00:00'),
('E-7', 'M-100', 'PowerRestore', '2023-01-01 13:00:00'),
('E-8', 'M-101', 'Ping', '2023-01-01 12:00:00'),
('E-9', 'M-102', 'Ping', '2023-01-01 12:00:00'),
('E-10', 'M-103', 'Ping', '2023-01-01 12:00:00');

-------------------------------------------------------------------------------
-- 4. EXAMPLE AI AGENT PROMPT
-------------------------------------------------------------------------------
/*
 * Prompt to Copy/Paste into Dremio AI:
 * "Analyze grid stability in Power_Grid.AMI_Data.
 *  
 *  1. Bronze: Raw View of READINGS, METERS, and EVENT_LOGS.
 *  2. Silver: 
 *     - Join: READINGS to METERS on Meter_ID.
 *     - Flag 'Spikes': Voltage > 130 or Voltage > 250.
 *     - Flag 'Confirmed Outage': If Voltage=0 AND Exists in EVENT_LOGS with Type='PowerOut'.
 *  3. Gold: 
 *     - SAIDI Metric: Sum of Outage Durations per Grid_Zone.
 *  
 *  Show the SQL."
 */
