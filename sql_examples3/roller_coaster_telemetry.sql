/*
 * Dremio "Messy Data" Challenge: Roller Coaster Telemetry
 * 
 * Scenario: Theme park monitoring rides from multiple manufacturers.
 * 3 Tables: COASTERS, SENSORS, RIDE_LOGS.
 * 
 * Objective for AI Agent:
 * 1. G-Force Validation: Filter impossible readings (>6G lateral, >10G vertical).
 * 2. Speed Unit Mixing: mph vs km/h firmware differences.
 * 3. Ride Duration Anomaly: Detect stuck trains (>5x normal) and e-stops (<30s).
 */

-------------------------------------------------------------------------------
-- 1. SETUP
-------------------------------------------------------------------------------

CREATE FOLDER IF NOT EXISTS Fun_World;
CREATE FOLDER IF NOT EXISTS Fun_World.Coaster_Ops;

-------------------------------------------------------------------------------
-- 2. DDL
-------------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS Fun_World.Coaster_Ops.COASTERS (
    COASTER_ID VARCHAR,
    COASTER_NAME VARCHAR,
    MANUFACTURER VARCHAR,
    TRACK_LENGTH_RAW VARCHAR,
    MAX_SPEED_RAW VARCHAR,
    OPEN_YEAR INT
);

CREATE TABLE IF NOT EXISTS Fun_World.Coaster_Ops.SENSORS (
    SENSOR_ID VARCHAR,
    COASTER_ID VARCHAR,
    SENSOR_TYPE VARCHAR,
    LOCATION_ON_TRACK VARCHAR,
    UNIT_RAW VARCHAR
);

CREATE TABLE IF NOT EXISTS Fun_World.Coaster_Ops.RIDE_LOGS (
    LOG_ID VARCHAR,
    COASTER_ID VARCHAR,
    SENSOR_ID VARCHAR,
    RIDE_TS TIMESTAMP,
    TRAIN_ID VARCHAR,
    READING_VAL DOUBLE,
    DISPATCH_TS TIMESTAMP,
    RETURN_TS TIMESTAMP,
    RIDE_STATUS VARCHAR
);

-------------------------------------------------------------------------------
-- 3. SEED DATA (50+ Records)
-------------------------------------------------------------------------------

INSERT INTO Fun_World.Coaster_Ops.COASTERS VALUES
('C-001', 'Thunder Bolt', 'B&M', '4200 ft', '62 mph', 2005),
('C-002', 'Steel Viper', 'Intamin', '5800 ft', '75 mph', 2010),
('C-003', 'Wooden Legend', 'GCI', '3800 ft', '55 mph', 1998),
('C-004', 'Sky Launcher', 'S&S', '1200 ft', '70 mph', 2018),
('C-005', 'Family Fun', 'Vekoma', '850 m', '40 km/h', 2015);

INSERT INTO Fun_World.Coaster_Ops.SENSORS VALUES
('S-001', 'C-001', 'Speed', 'Drop 1', 'mph'),
('S-002', 'C-001', 'G-Force', 'Loop 1', 'G'),
('S-003', 'C-001', 'Temperature', 'Brake Run', 'F'),
('S-004', 'C-002', 'Speed', 'Drop 1', 'mph'),
('S-005', 'C-002', 'G-Force', 'Inversion 1', 'G'),
('S-006', 'C-002', 'Vibration', 'Support Tower 5', 'mm/s'),
('S-007', 'C-003', 'Speed', 'Drop 1', 'mph'),
('S-008', 'C-003', 'Temperature', 'Track Section 12', 'F'),
('S-009', 'C-004', 'Speed', 'Launch', 'mph'),
('S-010', 'C-004', 'G-Force', 'Top Hat', 'G'),
('S-011', 'C-005', 'Speed', 'Drop 1', 'km/h'),
('S-012', 'C-005', 'G-Force', 'Helix', 'G');

INSERT INTO Fun_World.Coaster_Ops.RIDE_LOGS VALUES
-- Normal rides
('RL-001', 'C-001', 'S-001', '2023-07-01 10:00:00', 'T1-A', 60.5, '2023-07-01 10:00:00', '2023-07-01 10:02:05', 'Normal'),
('RL-002', 'C-001', 'S-002', '2023-07-01 10:00:30', 'T1-A', 3.8, '2023-07-01 10:00:00', '2023-07-01 10:02:05', 'Normal'),
('RL-003', 'C-001', 'S-003', '2023-07-01 10:01:50', 'T1-A', 185.0, '2023-07-01 10:00:00', '2023-07-01 10:02:05', 'Normal'),
('RL-004', 'C-001', 'S-001', '2023-07-01 10:05:00', 'T1-B', 61.2, '2023-07-01 10:05:00', '2023-07-01 10:07:10', 'Normal'),
('RL-005', 'C-001', 'S-002', '2023-07-01 10:05:30', 'T1-B', 3.9, '2023-07-01 10:05:00', '2023-07-01 10:07:10', 'Normal'),
('RL-006', 'C-002', 'S-004', '2023-07-01 10:10:00', 'T2-A', 73.1, '2023-07-01 10:10:00', '2023-07-01 10:12:30', 'Normal'),
('RL-007', 'C-002', 'S-005', '2023-07-01 10:10:30', 'T2-A', 4.2, '2023-07-01 10:10:00', '2023-07-01 10:12:30', 'Normal'),
('RL-008', 'C-002', 'S-006', '2023-07-01 10:11:00', 'T2-A', 2.5, '2023-07-01 10:10:00', '2023-07-01 10:12:30', 'Normal'),
-- G-Force impossible
('RL-009', 'C-001', 'S-002', '2023-07-01 10:15:30', 'T1-A', 15.0, '2023-07-01 10:15:00', '2023-07-01 10:17:05', 'Normal'),
('RL-010', 'C-002', 'S-005', '2023-07-01 10:20:30', 'T2-A', -8.5, '2023-07-01 10:20:00', '2023-07-01 10:22:30', 'Normal'),
-- Speed sensor glitch
('RL-011', 'C-001', 'S-001', '2023-07-01 10:25:00', 'T1-B', 250.0, '2023-07-01 10:25:00', '2023-07-01 10:27:05', 'Normal'),
('RL-012', 'C-002', 'S-004', '2023-07-01 10:30:00', 'T2-B', -5.0, '2023-07-01 10:30:00', '2023-07-01 10:32:30', 'Normal'),
-- Firmware sent km/h instead of mph
('RL-013', 'C-001', 'S-001', '2023-07-01 14:00:00', 'T1-A', 97.5, '2023-07-01 14:00:00', '2023-07-01 14:02:05', 'Normal'),
-- E-Stop (<30s)
('RL-014', 'C-002', 'S-004', '2023-07-02 09:00:00', 'T2-A', 15.0, '2023-07-02 09:00:00', '2023-07-02 09:00:25', 'E-Stop'),
('RL-015', 'C-002', 'S-005', '2023-07-02 09:00:05', 'T2-A', 0.5, '2023-07-02 09:00:00', '2023-07-02 09:00:25', 'E-Stop'),
-- Valleyed (stuck >5x normal)
('RL-016', 'C-003', 'S-007', '2023-07-02 11:00:00', 'T3-A', 10.0, '2023-07-02 11:00:00', '2023-07-02 11:15:00', 'Valleyed'),
('RL-017', 'C-003', 'S-007', '2023-07-02 11:05:00', 'T3-A', 0.0, '2023-07-02 11:00:00', '2023-07-02 11:15:00', 'Valleyed'),
-- Family Fun (metric)
('RL-018', 'C-005', 'S-011', '2023-07-01 10:00:00', 'T5-A', 38.5, '2023-07-01 10:00:00', '2023-07-01 10:01:30', 'Normal'),
('RL-019', 'C-005', 'S-012', '2023-07-01 10:00:20', 'T5-A', 2.0, '2023-07-01 10:00:00', '2023-07-01 10:01:30', 'Normal'),
-- NULL/edge cases
('RL-020', 'C-004', 'S-009', '2023-07-01 12:00:00', 'T4-A', NULL, '2023-07-01 12:00:00', NULL, NULL),
('RL-021', 'C-004', 'S-010', '2023-07-01 12:00:05', 'T4-A', 4.5, NULL, '2023-07-01 12:00:30', 'Normal'),
-- Duplicate
('RL-022', 'C-001', 'S-001', '2023-07-01 10:00:00', 'T1-A', 60.5, '2023-07-01 10:00:00', '2023-07-01 10:02:05', 'Normal'),
-- Status mess
('RL-023', 'C-001', 'S-001', '2023-07-03 10:00:00', 'T1-A', 59.8, '2023-07-03 10:00:00', '2023-07-03 10:02:10', 'NORMAL'),
('RL-024', 'C-002', 'S-004', '2023-07-03 10:10:00', 'T2-A', 74.0, '2023-07-03 10:10:00', '2023-07-03 10:12:35', 'normal'),
-- Sky Launcher (~30s)
('RL-025', 'C-004', 'S-009', '2023-07-03 12:00:00', 'T4-A', 68.5, '2023-07-03 12:00:00', '2023-07-03 12:00:35', 'Normal'),
('RL-026', 'C-004', 'S-010', '2023-07-03 12:00:05', 'T4-A', 4.8, '2023-07-03 12:00:00', '2023-07-03 12:00:35', 'Normal'),
-- Bulk fill
('RL-027', 'C-001', 'S-001', '2023-07-03 10:10:00', 'T1-B', 61.0, '2023-07-03 10:10:00', '2023-07-03 10:12:05', 'Normal'),
('RL-028', 'C-001', 'S-002', '2023-07-03 10:10:30', 'T1-B', 3.7, '2023-07-03 10:10:00', '2023-07-03 10:12:05', 'Normal'),
('RL-029', 'C-002', 'S-004', '2023-07-03 10:15:00', 'T2-B', 72.5, '2023-07-03 10:15:00', '2023-07-03 10:17:30', 'Normal'),
('RL-030', 'C-002', 'S-005', '2023-07-03 10:15:30', 'T2-B', 4.1, '2023-07-03 10:15:00', '2023-07-03 10:17:30', 'Normal'),
('RL-031', 'C-003', 'S-007', '2023-07-03 11:00:00', 'T3-A', 53.0, '2023-07-03 11:00:00', '2023-07-03 11:01:45', 'Normal'),
('RL-032', 'C-003', 'S-008', '2023-07-03 11:01:30', 'T3-A', 140.0, '2023-07-03 11:00:00', '2023-07-03 11:01:45', 'Normal'),
('RL-033', 'C-004', 'S-009', '2023-07-03 12:05:00', 'T4-A', 69.0, '2023-07-03 12:05:00', '2023-07-03 12:05:32', 'Normal'),
('RL-034', 'C-004', 'S-010', '2023-07-03 12:05:05', 'T4-A', 4.9, '2023-07-03 12:05:00', '2023-07-03 12:05:32', 'Normal'),
('RL-035', 'C-005', 'S-011', '2023-07-03 10:05:00', 'T5-A', 39.0, '2023-07-03 10:05:00', '2023-07-03 10:06:30', 'Normal'),
('RL-036', 'C-005', 'S-012', '2023-07-03 10:05:20', 'T5-A', 2.1, '2023-07-03 10:05:00', '2023-07-03 10:06:30', 'Normal'),
('RL-037', 'C-001', 'S-001', '2023-07-04 10:00:00', 'T1-A', 60.0, '2023-07-04 10:00:00', '2023-07-04 10:02:00', 'Normal'),
('RL-038', 'C-001', 'S-002', '2023-07-04 10:00:30', 'T1-A', 3.6, '2023-07-04 10:00:00', '2023-07-04 10:02:00', 'Normal'),
('RL-039', 'C-002', 'S-004', '2023-07-04 10:10:00', 'T2-A', 74.5, '2023-07-04 10:10:00', '2023-07-04 10:12:25', 'Normal'),
('RL-040', 'C-002', 'S-005', '2023-07-04 10:10:30', 'T2-A', 4.3, '2023-07-04 10:10:00', '2023-07-04 10:12:25', 'Normal'),
('RL-041', 'C-003', 'S-007', '2023-07-04 11:00:00', 'T3-A', 54.0, '2023-07-04 11:00:00', '2023-07-04 11:01:50', 'Normal'),
('RL-042', 'C-004', 'S-009', '2023-07-04 12:00:00', 'T4-A', 70.0, '2023-07-04 12:00:00', '2023-07-04 12:00:34', 'Normal'),
('RL-043', 'C-005', 'S-011', '2023-07-04 10:00:00', 'T5-A', 37.0, '2023-07-04 10:00:00', '2023-07-04 10:01:25', 'Normal'),
('RL-044', 'C-005', 'S-012', '2023-07-04 10:00:20', 'T5-A', 1.9, '2023-07-04 10:00:00', '2023-07-04 10:01:25', 'Normal'),
-- Orphan
('RL-045', 'C-999', 'S-001', '2023-07-05 10:00:00', 'TX-A', 50.0, '2023-07-05 10:00:00', '2023-07-05 10:02:00', 'Normal'),
-- Temp anomalies
('RL-046', 'C-001', 'S-003', '2023-07-04 14:00:00', 'T1-A', 350.0, '2023-07-04 14:00:00', '2023-07-04 14:02:05', 'Normal'),
('RL-047', 'C-003', 'S-008', '2023-07-04 14:00:00', 'T3-A', -40.0, '2023-07-04 14:00:00', '2023-07-04 14:01:50', 'Normal'),
-- More normal
('RL-048', 'C-001', 'S-001', '2023-07-05 10:00:00', 'T1-A', 59.5, '2023-07-05 10:00:00', '2023-07-05 10:02:08', 'Normal'),
('RL-049', 'C-002', 'S-004', '2023-07-05 10:10:00', 'T2-A', 73.8, '2023-07-05 10:10:00', '2023-07-05 10:12:28', 'Normal'),
('RL-050', 'C-003', 'S-007', '2023-07-05 11:00:00', 'T3-A', 52.5, '2023-07-05 11:00:00', '2023-07-05 11:01:48', 'Normal');

-------------------------------------------------------------------------------
-- 4. EXAMPLE AI AGENT PROMPT
-------------------------------------------------------------------------------
/*
 * Prompt to Copy/Paste into Dremio AI:
 * "Analyze ride safety in Fun_World.Coaster_Ops.
 *  
 *  1. Bronze: Raw Views of COASTERS, SENSORS, RIDE_LOGS.
 *  2. Silver: 
 *     - Speed: Normalize to mph. IF sensor UNIT='km/h' THEN value/1.609. Flag > MAX_SPEED * 1.2.
 *     - G-Force: Flag ABS(value) > 6 as sensor error.
 *     - Duration: Calculate RETURN_TS - DISPATCH_TS. Flag < 30s (e-stop) and > 5 min (stuck).
 *     - Status: UPPER(RIDE_STATUS). Filter NULLs.
 *  3. Gold: 
 *     - Safety Score per Coaster: % of rides with no anomalies.
 *     - Daily Throughput: Rides per hour per coaster.
 *     - Maintenance Alert: Coasters with > 3 anomalies in a day.
 *  
 *  Show the SQL."
 */
