/*
 * Dremio "Messy Data" Challenge: Dirty Telecom CDRs
 * 
 * Scenario: 
 * Call Detail Records (CDRs) have inconsistent phone number formatting.
 * Some records have dashes, dots, parentheses, or country codes +1 vs 001.
 * 'Duration' field sometimes has 's' or 'm' suffixes (e.g. '30s', '1m').
 * 
 * Objective for AI Agent:
 * 1. Clean Phone Numbers to E.164 standard (+15551234567).
 * 2. Convert Duration to integer Seconds.
 * 3. Aggregate Total Talk Time per clean Number.
 */

-------------------------------------------------------------------------------
-- 1. SETUP: Create Raw Folder
-------------------------------------------------------------------------------

CREATE FOLDER IF NOT EXISTS Telecom_Lake;
CREATE FOLDER IF NOT EXISTS Telecom_Lake.CDR_Raw;

-------------------------------------------------------------------------------
-- 2. DDL: Create Raw Tables
-------------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS Telecom_Lake.CDR_Raw.SWITCH_LOGS (
    CALL_ID VARCHAR,
    A_NUM VARCHAR, -- Caller
    B_NUM VARCHAR, -- Callee
    DUR_STR VARCHAR, -- '10s', '5m'
    TS TIMESTAMP
);

-------------------------------------------------------------------------------
-- 3. SEED DATA (Regex Nightmares)
-------------------------------------------------------------------------------

-- Standard US
INSERT INTO Telecom_Lake.CDR_Raw.SWITCH_LOGS VALUES
('C-001', '555-0100', '555-0101', '30s', '2023-01-01 10:00:00'),
('C-002', '(555) 0100', '555-0102', '1m', '2023-01-01 10:05:00');

-- Dots, Spaces, Country Codes
INSERT INTO Telecom_Lake.CDR_Raw.SWITCH_LOGS VALUES
('C-003', '555.0100', '555 0103', '45s', '2023-01-01 10:10:00'),
('C-004', '+1-555-0100', '0015550104', '2m 10s', '2023-01-01 10:15:00'), -- Complex duration
('C-005', '1-555-0100', '5550105', '10', '2023-01-01 10:20:00'); -- No suffix (assume sec)

-- International / Bad Formats
INSERT INTO Telecom_Lake.CDR_Raw.SWITCH_LOGS VALUES
('C-006', '011-44-20-7946-0100', '555-0100', '500s', '2023-01-01 10:25:00'), -- UK
('C-007', 'Unknown', '911', '10s', '2023-01-01 10:30:00');

-- Bulk Fill
INSERT INTO Telecom_Lake.CDR_Raw.SWITCH_LOGS VALUES
('C-010', '555-0100', '555-0200', '60s', '2023-01-01 11:00:00'),
('C-011', '555.0100', '555-0201', '60s', '2023-01-01 11:05:00'),
('C-012', '5550100', '555-0202', '60s', '2023-01-01 11:10:00'),
('C-013', '+15550100', '555-0203', '60s', '2023-01-01 11:15:00'),
('C-014', '(555)-0100', '555-0204', '60s', '2023-01-01 11:20:00'),
('C-015', '555-0101', '555-0100', '2m', '2023-01-01 11:25:00'),
('C-016', '555.0101', '555.0100', '2m', '2023-01-01 11:30:00'),
('C-017', '555 0101', '555 0100', '2m', '2023-01-01 11:35:00'),
('C-018', '555-0102', '555-0300', '1h', '2023-01-01 12:00:00'), -- Hour!
('C-019', '555-0102', '555-0301', '1.5m', '2023-01-01 12:05:00'), -- Decimal minute
('C-020', '555-0103', '555-0100', '10s', '2023-01-01 12:10:00'),
('C-021', '555-0103', '555-0100', '20S', '2023-01-01 12:15:00'), -- Case
('C-022', '555-0103', '555-0100', '30 S', '2023-01-01 12:20:00'), -- Space
('C-023', 'INVALID', 'INVALID', '0s', '2023-01-01 12:25:00'),
('C-024', '', '', '0', '2023-01-01 12:30:00'), -- Empty strings
('C-025', '555-0100', '411', '120s', '2023-01-01 13:00:00'),
('C-026', '555-0100', '555-0101', '120s', '2023-01-01 13:05:00'),
('C-027', '555-0100', '555-0102', '120s', '2023-01-01 13:10:00'),
('C-028', '555-0100', '555-0103', '120s', '2023-01-01 13:15:00'),
('C-029', '555-0100', '555-0104', '120s', '2023-01-01 13:20:00'),
('C-030', '+44 20 7946 0000', '555-0100', '5m', '2023-01-01 14:00:00'),
('C-031', '0044 20 7946 0000', '555-0100', '5m', '2023-01-01 14:05:00'),
('C-032', '442079460000', '555-0100', '5m', '2023-01-01 14:10:00'),
('C-033', '1-800-555-0199', '555-0100', '10m', '2023-01-01 14:15:00'),
('C-034', '800 555 0199', '555-0100', '10m', '2023-01-01 14:20:00'),
('C-035', '+1 (800) 555-0199', '555-0100', '10m', '2023-01-01 14:25:00'),
('C-036', '555-0100', '911', 'NA', '2023-01-01 15:00:00'), -- Bad duration
('C-037', '555-0100', '911', '???', '2023-01-01 15:05:00'),
('C-038', '555-0100', '911', 'FAIL', '2023-01-01 15:10:00'),
('C-039', '555-0100', '911', '0', '2023-01-01 15:15:00'),
('C-040', '555-0100', '911', '0', '2023-01-01 15:20:00'),
('C-041', '555-0100', '555-0105', '60', '2023-01-01 16:00:00'),
('C-042', '555-0100', '555-0105', '60.5s', '2023-01-01 16:05:00'),
('C-043', '555-0100', '555-0105', '60,5s', '2023-01-01 16:10:00'), -- Comma decimal
('C-044', '555-0100', '555-0105', '1:00', '2023-01-01 16:15:00'), -- Time format
('C-045', '555-0100', '555-0105', '00:30', '2023-01-01 16:20:00'),
('C-046', '555-0101', '555-0100', '5s', '2023-01-01 17:00:00'),
('C-047', '555-0101', '555-0100', '5s', '2023-01-01 17:01:00'),
('C-048', '555-0101', '555-0100', '5s', '2023-01-01 17:02:00'),
('C-049', '555-0101', '555-0100', '5s', '2023-01-01 17:03:00'),
('C-050', '555-0101', '555-0100', '5s', '2023-01-01 17:04:00');

-------------------------------------------------------------------------------
-- 4. EXAMPLE AI AGENT PROMPT
-------------------------------------------------------------------------------
/*
 * Prompt to Copy/Paste into Dremio AI:
 * "Clean the telecom logs in Telecom_Lake.CDR_Raw.SWITCH_LOGS using Dremio SQL.
 *  
 *  1. Bronze: Raw View.
 *  2. Silver: 
 *     - Standardize Phone Numbers: Remove '(', ')', '-', '.', and spaces. Ensure E.164 format.
 *     - Normalize 'DUR_STR' (Duration): Convert '1m', '30s', '1h' to integer Total Seconds.
 *     - Handle empty strings and nulls.
 *  3. Gold: 
 *     - Aggregate Total Talk Time (in Minutes) by Origination Number (A_NUM).
 *  
 *  Show me the SQL."
 */
