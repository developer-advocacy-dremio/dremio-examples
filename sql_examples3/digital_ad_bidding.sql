/*
 * Dremio "Messy Data" Challenge: Digital Ad Bidding
 * 
 * Scenario: 
 * RTB Bidding logs.
 * 3 Tables: CAMPAIGNS (Meta), BIDS (Sent), WINS (Received).
 * 
 * Objective for AI Agent:
 * 1. Join Tables: Match BIDS to WINS on Auction_ID.
 * 2. Calc Stats: Win Rate = Count(Wins) / Count(Bids).
 * 3. Currency: Handle micro-CPM float precision.
 */

-------------------------------------------------------------------------------
-- 1. SETUP: Create Raw Folder
-------------------------------------------------------------------------------

CREATE FOLDER IF NOT EXISTS Ad_Exchange;
CREATE FOLDER IF NOT EXISTS Ad_Exchange.RTB;

-------------------------------------------------------------------------------
-- 2. DDL: Create Raw Tables (3 Tables)
-------------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS Ad_Exchange.RTB.CAMPAIGNS (
    CAMPAIGN_ID VARCHAR,
    ADVERTISER VARCHAR,
    BUDGET DOUBLE
);

CREATE TABLE IF NOT EXISTS Ad_Exchange.RTB.BIDS (
    AUCTION_ID VARCHAR,
    CAMPAIGN_ID VARCHAR,
    TS TIMESTAMP,
    BID_CPM FLOAT
);

CREATE TABLE IF NOT EXISTS Ad_Exchange.RTB.WINS (
    AUCTION_ID VARCHAR,
    TS TIMESTAMP,
    WIN_PRICE_CPM FLOAT,
    EXCHANGE_ID VARCHAR
);

-------------------------------------------------------------------------------
-- 3. SEED DATA (50+ Records)
-------------------------------------------------------------------------------

-- CAMPAIGNS
INSERT INTO Ad_Exchange.RTB.CAMPAIGNS VALUES
('C-1', 'Nike', 1000.0), ('C-2', 'Coke', 5000.0), ('C-3', 'Apple', 10000.0);

-- BIDS (50 Rows)
INSERT INTO Ad_Exchange.RTB.BIDS VALUES
('A-1', 'C-1', '2023-01-01 10:00:00.100', 1.50), ('A-2', 'C-1', '2023-01-01 10:00:00.150', 1.55),
('A-3', 'C-2', '2023-01-01 10:00:01.000', 2.00), ('A-4', 'C-3', '2023-01-01 10:00:00.000', 0.12345678),
('A-5', 'C-3', '2023-01-01 10:00:00.000', 0.00000001), ('A-6', 'C-1', '2023-01-01 12:00:00', 1.0),
('A-7', 'C-1', '2023-01-01 12:00:00', 1.1), ('A-8', 'C-1', '2023-01-01 12:00:00', 1.2),
('A-9', 'C-1', '2023-01-01 12:00:00', 1.0), ('A-10', 'C-1', '2023-01-01 12:00:00', 1.0),
('A-11', 'C-2', '2023-01-01 12:00:00', 1.0), ('A-12', 'C-2', '2023-01-01 12:00:00', 1.0),
('A-13', 'C-2', '2023-01-01 12:00:00', 1.0), ('A-14', 'C-2', '2023-01-01 12:00:00', 1.0),
('A-15', 'C-2', '2023-01-01 12:00:00', 1.0), ('A-16', 'C-2', '2023-01-01 12:00:00', 1.0),
('A-17', 'C-2', '2023-01-01 12:00:00', 1.0), ('A-18', 'C-3', '2023-01-01 12:00:00', 0.0),
('A-19', 'C-3', '2023-01-01 12:00:00', -1.0), ('A-20', 'C-3', '2023-01-01 12:00:00', 1000000.0),
('A-21', 'C-3', '2023-01-01 12:00:00', NULL), ('A-22', 'C-3', '2023-01-01 12:00:00', 1.0),
('A-23', 'C-3', '2023-01-01 12:00:00', 1.0), ('A-24', NULL, '2023-01-01 12:00:00', 1.0),
('A-25', 'C-1', NULL, 1.0), ('A-26', 'C-1', '2023-01-01 12:00:00', 1.0),
('A-27', 'C-1', '2023-01-01 12:00:00', 1.0), ('A-28', 'C-1', '2023-01-01 12:00:00', 1.0),
('A-29', 'C-1', '2023-01-01 12:00:00', 1.0), ('A-30', 'C-1', '2023-01-01 12:00:00', 1.0),
('A-31', 'C-1', '2023-01-01 12:00:00', 1.0), ('A-32', 'C-1', '2023-01-01 12:00:00', 1.0),
('A-33', 'C-1', '2023-01-01 12:00:00', 1.0), ('A-34', 'C-1', '2023-01-01 12:00:00', 1.0),
('A-35', 'C-1', '2023-01-01 12:00:00', 1.0), ('A-36', 'C-1', '2023-01-01 12:00:00', 1.0),
('A-37', 'C-1', '2023-01-01 12:00:00', 1.0), ('A-38', 'C-1', '2023-01-01 12:00:00', 1.0),
('A-39', 'C-1', '2023-01-01 12:00:00', 1.0), ('A-40', 'C-1', '2023-01-01 12:00:00', 1.0),
('A-41', 'C-1', '2023-01-01 12:00:00', 1.0), ('A-42', 'C-1', '2023-01-01 12:00:00', 1.0),
('A-43', 'C-1', '2023-01-01 12:00:00', 1.0), ('A-44', 'C-1', '2023-01-01 12:00:00', 1.0),
('A-45', 'C-1', '2023-01-01 12:00:00', 1.0), ('A-46', 'C-1', '2023-01-01 12:00:00', 1.0),
('A-47', 'C-1', '2023-01-01 12:00:00', 1.0), ('A-48', 'C-1', '2023-01-01 12:00:00', 1.0),
('A-49', 'C-1', '2023-01-01 12:00:00', 1.0), ('A-50', 'C-1', '2023-01-01 12:00:00', 1.0);

-- WINS (10 Rows)
INSERT INTO Ad_Exchange.RTB.WINS VALUES
('A-1', '2023-01-01 10:00:00.200', 1.56, 'Ex-1'), ('A-3', '2023-01-01 10:00:05.000', 5.00, 'Ex-2'),
('A-6', '2023-01-01 12:00:00', 1.21, 'Ex-1'), ('A-7', '2023-01-01 12:00:00', 1.21, 'Ex-1'),
('A-8', '2023-01-01 12:00:00', 1.21, 'Ex-1'), ('A-9', '2023-01-01 12:00:00', 1.21, 'Ex-1'),
('A-10', '2023-01-01 12:00:00', 1.21, 'Ex-1'), ('A-11', '2023-01-01 12:00:00', 1.21, 'Ex-1'),
('A-12', '2023-01-01 12:00:00', 1.21, 'Ex-1'), ('A-99', '2023-01-01 12:00:00', 1.21, 'Ex-1'); -- Win no Bid

-------------------------------------------------------------------------------
-- 4. EXAMPLE AI AGENT PROMPT
-------------------------------------------------------------------------------
/*
 * Prompt to Copy/Paste into Dremio AI:
 * "Optimize bidding in Ad_Exchange.RTB.
 *  
 *  1. Bronze: Raw View of BIDS, WINS, CAMPAIGNS.
 *  2. Silver: 
 *     - Join: BIDS and WINS on AUCTION_ID.
 *     - Calc Stats: Win_Price / Bid_CPM.
 *  3. Gold: 
 *     - Campaign Report: Total Bids vs Total Wins (Win Rate %) per Campaign.
 *  
 *  Show the SQL."
 */
