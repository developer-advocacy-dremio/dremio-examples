/*
 * Dremio "Messy Data" Challenge: Erroneous Energy Readings
 * 
 * Scenario: 
 * Smart meters send Voltage and Amperage readings.
 * Malfunctioning meters report negative usage, or Impossible voltages (e.g. 0V or 5000V).
 * 
 * Objective for AI Agent:
 * 1. Calculate Watts = Volts * Amps.
 * 2. Filter out Negative Watts (Impossible).
 * 3. Filter out Voltage spikes (> 250V) or sags (< 100V).
 * 4. Average valid usage per Meter.
 */

-------------------------------------------------------------------------------
-- 1. SETUP: Create Raw Folder
-------------------------------------------------------------------------------

CREATE FOLDER IF NOT EXISTS Grid_Logs;
CREATE FOLDER IF NOT EXISTS Grid_Logs.Meter_Raw;

-------------------------------------------------------------------------------
-- 2. DDL: Create Raw Tables
-------------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS Grid_Logs.Meter_Raw.VOLT_DUMP (
    M_ID VARCHAR,
    TS TIMESTAMP,
    VOLTS DOUBLE, -- 110-120V is normal
    AMPS DOUBLE,
    ERR_CODE INT -- 0=OK, 1=Warn, 99=Crit
);

-------------------------------------------------------------------------------
-- 3. SEED DATA (Outliers, Negatives)
-------------------------------------------------------------------------------

-- Normal
INSERT INTO Grid_Logs.Meter_Raw.VOLT_DUMP VALUES
('M-101', '2023-01-01 12:00:00', 120.5, 10.0, 0),
('M-102', '2023-01-01 12:00:00', 119.8, 5.0, 0);

-- Negative Usage (Error)
INSERT INTO Grid_Logs.Meter_Raw.VOLT_DUMP VALUES
('M-101', '2023-01-01 12:05:00', 120.0, -10.0, 1), -- Negative Amps?
('M-103', '2023-01-01 12:00:00', -120.0, 5.0, 1); -- Negative Volts?

-- Spikes/Sags
INSERT INTO Grid_Logs.Meter_Raw.VOLT_DUMP VALUES
('M-101', '2023-01-01 12:10:00', 5000.0, 10.0, 99), -- Lightning strike?
('M-102', '2023-01-01 12:10:00', 0.0, 0.0, 99); -- Blackout

-- Bulk Fill
INSERT INTO Grid_Logs.Meter_Raw.VOLT_DUMP VALUES
('M-104', '2023-01-01 12:00:00', 120.0, 5.0, 0),
('M-104', '2023-01-01 12:05:00', 120.0, 5.5, 0),
('M-104', '2023-01-01 12:10:00', 120.0, 6.0, 0),
('M-104', '2023-01-01 12:15:00', 120.0, 6.5, 0),
('M-104', '2023-01-01 12:20:00', 120.0, 7.0, 0),
('M-105', '2023-01-01 12:00:00', 115.0, 2.0, 0),
('M-105', '2023-01-01 12:05:00', 115.0, 2.0, 0),
('M-105', '2023-01-01 12:10:00', 115.0, 2.0, 0),
('M-105', '2023-01-01 12:15:00', 115.0, 2.0, 0),
('M-105', '2023-01-01 12:20:00', 115.0, 2.0, 0),
('M-106', '2023-01-01 12:00:00', 240.0, 10.0, 0), -- High voltage indus
('M-106', '2023-01-01 12:05:00', 240.0, 10.0, 0),
('M-106', '2023-01-01 12:10:00', 240.0, 10.0, 0),
('M-106', '2023-01-01 12:15:00', 240.0, 10.0, 0),
('M-106', '2023-01-01 12:20:00', 240.0, 10.0, 0),
('M-107', '2023-01-01 12:00:00', 121.0, 1.0, 0),
('M-107', '2023-01-01 12:05:00', 121.0, 1.0, 0),
('M-107', '2023-01-01 12:10:00', 121.0, 1.0, 0),
('M-107', '2023-01-01 12:15:00', 121.0, 1.0, 0),
('M-107', '2023-01-01 12:20:00', 121.0, 1.0, 0),
('M-108', '2023-01-01 12:00:00', 10.0, 0.0, 99), -- Brownout
('M-108', '2023-01-01 12:05:00', 10.0, 0.0, 99),
('M-108', '2023-01-01 12:10:00', 10.0, 0.0, 99),
('M-108', '2023-01-01 12:15:00', 10.0, 0.0, 99),
('M-108', '2023-01-01 12:20:00', 10.0, 0.0, 99),
('M-109', '2023-01-01 12:00:00', 120.0, 0.5, 0),
('M-109', '2023-01-01 12:05:00', 120.0, 0.5, 0),
('M-109', '2023-01-01 12:10:00', 120.0, 0.5, 0),
('M-109', '2023-01-01 12:15:00', 120.0, 0.5, 0),
('M-109', '2023-01-01 12:20:00', 120.0, 0.5, 0),
('M-110', '2023-01-01 12:00:00', 300.0, 5.0, 1), -- Surge
('M-110', '2023-01-01 12:05:00', 310.0, 5.0, 1),
('M-110', '2023-01-01 12:10:00', 320.0, 5.0, 1),
('M-110', '2023-01-01 12:15:00', 310.0, 5.0, 1),
('M-110', '2023-01-01 12:20:00', 300.0, 5.0, 1),
('M-101', '2023-01-01 12:15:00', -120.0, -10.0, 1), -- Double negative?
('M-101', '2023-01-01 12:20:00', 120.0, 10.0, 0),
('M-101', '2023-01-01 12:25:00', 120.0, 10.0, 0),
('M-102', '2023-01-01 12:15:00', 120.0, 5.0, 0),
('M-102', '2023-01-01 12:20:00', 120.0, 5.0, 0);

-------------------------------------------------------------------------------
-- 4. EXAMPLE AI AGENT PROMPT
-------------------------------------------------------------------------------
/*
 * Prompt to Copy/Paste into Dremio AI:
 * "Sanitize the smart meter data in Grid_Logs.Meter_Raw.VOLT_DUMP.
 *  
 *  1. Bronze: Raw View.
 *  2. Silver: 
 *     - Derive 'Watts' column = Volts * Amps.
 *     - Filter out rows where Watts < 0 (Impossible Physics).
 *     - Filter out Voltage Spikes (> 250V) or Sags (< 100V).
 *  3. Gold: 
 *     - Compute the Average clean Wattage per Meter ID on 5-minute intervals.
 *  
 *  Provide the SQL implementation."
 */
